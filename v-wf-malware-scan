#!/bin/bash

# Check if domain name is provided
if [ -z "$1" ]; then
    echo "Error: Domain name is required"
    exit 1
fi

# Get the domain name
DOMAIN=$1

# Shift off the first argument (domain name) to process additional flags
shift

# Use v-search-domain-owner to find the user associated with the domain
USER=$(v-search-domain-owner $DOMAIN)
if [ -z "$USER" ]; then
    echo "Error: Unable to find user for domain $DOMAIN"
    exit 1
fi

# Construct the scan path
SCAN="/home/$USER/web/$DOMAIN/public_html"

echo "Starting Wordfence scan for $DOMAIN at $SCAN"

# Change directory to where Docker commands can be executed
cd /root/wordfence-cli

# Run Wordfence scan using Docker with additional flags
docker run -it -v /var/www:/var/www -v /root/wfcli-conf/wordfence-cli.ini:/root/.config/wordfence/wordfence-cli.ini -v $SCAN:$SCAN wordfence-cli:latest malware-scan $SCAN --output-format csv --output-path $SCAN/wordfence-cli-scan.csv "$@"

# Display suspicious files
echo "Suspicious files for $DOMAIN:"
cat $SCAN/wordfence-cli-scan.csv
rm $SCAN/wordfence-cli-scan.csv
